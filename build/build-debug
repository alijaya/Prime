#!/bin/bash

BUILDSCRIPTDIR="`dirname $0`";
PRJROOT="${BUILDSCRIPTDIR}/.."

MINPARAMS=1
Style="flair"
MainClass="primevc.Main"
OUTPUT="bin-debug/app.swf"
WIDTH=1300
HEIGHT=900
FPS=31
BGCOLOR=FFFFFF

#parse arguments
while getopts "a:bc:ds:tw:uh:idf" OptionName
	do
		case $OptionName in
			a ) MainClass=${OPTARG};;	#main class
			c ) BGCOLOR=${OPTARG};;		#background color
			s ) Style=${OPTARG};;		#style name
			d ) Debug="-debug";;		#compile cssparser and application in debugmode
			f ) Force=true;;			#force recompilation of css parser
			w ) WIDTH=${OPTARG};;		#width
			h ) HEIGHT=${OPTARG};;		#height
	esac
done

Style="skins/${Style}"
ASSETS=""

if [[ -f "${Style}/Assets.swf" ]] ; then
	ASSETS="-swf-lib ${Style}/Assets.swf"
fi;

echo "==================== BUILD${Debug:+ DEBUG} ===================="

if [[ ${MainClass} == "" ]] ; then
	echo "Error: Mainclass is not specified"
else
	echo "Main: ${MainClass}"
	echo "Style: ${Style}"
	echo "Debugging: ${Debug:-false}"
	echo "Assets: ${ASSETS}"
	
	echo "1. BUILDING ASSETS" &&
	bash ${PRJROOT}/build/build-assets &&
	echo "2. BUILDING STYLES" &&
	bash ${PRJROOT}/build/build-styles -s ${Style} ${Debug:+-d} ${Force:+-f} &&
	echo "3. COMPILING SWF" &&
	mkdir -p "${PRJROOT}/bin-debug" &&
	echo "${PRJROOT}/build/build.hxml -swf $OUTPUT -main $MainClass ${Debug:---no-traces} -cp ${Style} -cp tests" &&
	haxe ${PRJROOT}/build/build.hxml -swf $OUTPUT -main $MainClass ${Debug:---no-traces} -cp ${Style} -cp tests -swf-header $WIDTH:$HEIGHT:$FPS:$BGCOLOR $ASSETS &&
	
	if (set -u; : $Debug) 2> /dev/null ; then
		#mv ${PRJROOT}/tmp.swf ${PRJROOT}/bin-debug/app.swf &&
		open $OUTPUT
	else
		echo "4. OPTIMIZING BUILD" &&
		bash ${PRJROOT}/build/optimize-build $OUTPUT &&
		open $OUTPUT
	fi;
fi;