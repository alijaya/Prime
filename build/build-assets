#!bash

BUILDSCRIPTDIR="`dirname "$0"`";
PRIMEVC_ROOT="$BUILDSCRIPTDIR/.."

if [[ ! -f "$PRIMEVC_ROOT/build/environment.sh" ]]; then
	echo -e "\tThere's no environment file: \"`cd $PRIMEVC_ROOT/build; pwd`/environment.sh\" configured. Copy 'environment.sh.template' to 'environment.sh' and edit it."
	exit 1
else
	if [[ ! -f "$PRIMEVC_ROOT/assets/debug-assets.swf" ]]  ||  test "$PRIMEVC_ROOT/assets/DebugAssets.as" -nt "$PRIMEVC_ROOT/assets/debug-assets.swf"  ||  test "$PRIMEVC_ROOT/assets/Assets.as" -nt "$PRIMEVC_ROOT/assets/assets.swf"; then
		source "$PRIMEVC_ROOT/build/environment.sh"
		if [[ ! -f "$MXMLC" ]]; then
			echo -e "\t[error]  Not found: $MXMLC"
			exit 1
		fi;
		
		echo -e "\t[mxmlc]  Compiling asset SWFs"
		
		if [[ -d "$PRIMEVC_ROOT/generated-src" ]]; then
			rm -R "$PRIMEVC_ROOT/generated-src"
		fi;
		
		"$MXMLC" \
			-compiler.source-path "$PRIMEVC_ROOT/src" "$PRIMEVC_ROOT/libs/macmousewheel" "$PRIMEVC_ROOT/libs/as3-flexless" "$PRIMEVC_ROOT/libs/swfaddress" \
			-compiler.as3 \
			-debug=false \
			-verbose-stacktraces=false \
			-compiler.optimize \
			-output "$PRIMEVC_ROOT/assets/assets.swf" \
			"$PRIMEVC_ROOT/assets/Assets.as" &&

		"$MXMLC" \
			-compiler.source-path "$PRIMEVC_ROOT/src" "$PRIMEVC_ROOT/libs/macmousewheel" "$PRIMEVC_ROOT/libs/monsterdebugger" "$PRIMEVC_ROOT/libs/as3-flexless" "$PRIMEVC_ROOT/libs/alcon" "$PRIMEVC_ROOT/libs/swfaddress" \
			-compiler.as3 \
			-output "$PRIMEVC_ROOT/assets/debug-assets.swf" \
			"$PRIMEVC_ROOT/assets/DebugAssets.as" &&
		
		echo -e "\t[haXe]   Generating extern classes" &&
		
		haxe --gen-hx-classes "$PRIMEVC_ROOT/assets/debug-assets.swf" &&
		mv hxclasses "$PRIMEVC_ROOT/generated-src"
		rm "$PRIMEVC_ROOT/generated-src/Assets.hx"
		rm "$PRIMEVC_ROOT/generated-src/DebugAssets.hx"
		
		# Cleanup
	#	rm -R "$PRIMEVC_ROOT/hxclasses"
	fi;
fi;
