#!bash

BUILDSCRIPTDIR="`dirname $0`";
PRJROOT="${BUILDSCRIPTDIR}/.."

if [[ ! -f ${PRJROOT}/build/environment.sh ]]; then
	echo "There's no environment file configured. Copy 'environment.sh.template' to 'environment.sh' and edit it."
	exit 1
else
	if [[ ! -f ${PRJROOT}/assets/debug-assets.swf ]]  ||  test ${PRJROOT}/assets/DebugAssets.as -nt ${PRJROOT}/assets/debug-assets.swf  ||  test ${PRJROOT}/assets/Assets.as -nt ${PRJROOT}/assets/assets.swf ; then
		echo "[mxmlc]  Compiling asset SWFs"
		
		source ${PRJROOT}/build/environment.sh
		
		if [[ -d ${PRJROOT}/generated-src ]]; then
			rm -R ${PRJROOT}/generated-src
		fi;
		
		"$MXMLC" \
			-compiler.source-path "${PRJROOT}/src" "${PRJROOT}/libs/macmousewheel" "${PRJROOT}/libs/monsterdebugger" "${PRJROOT}/libs/as3-flexless" \
			-compiler.as3 \
			-debug=false \
			-verbose-stacktraces=false \
			-compiler.optimize \
			-output ${PRJROOT}/assets/assets.swf \
			${PRJROOT}/assets/Assets.as &&

		"$MXMLC" \
			-compiler.source-path "${PRJROOT}/src" "${PRJROOT}/libs/macmousewheel" "${PRJROOT}/libs/monsterdebugger" "${PRJROOT}/libs/as3-flexless" \
			-compiler.as3 \
			-output ${PRJROOT}/assets/debug-assets.swf \
			${PRJROOT}/assets/DebugAssets.as &&
		
		echo "[haXe]   Generating extern classes" &&
		
		haxe --gen-hx-classes ${PRJROOT}/assets/debug-assets.swf &&
		mv hxclasses ${PRJROOT}/generated-src
		rm ${PRJROOT}/generated-src/Assets.hx
		rm ${PRJROOT}/generated-src/DebugAssets.hx
		
		# Cleanup
	#	rm -R ${PRJROOT}/hxclasses
	fi;
fi;
